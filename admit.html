<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Edit Survey Content</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .login-container p {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s ease;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        /* Admin Interface Styles (hidden until login) */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }

        .admin-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .admin-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .admin-header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .admin-nav {
            background: #ecf0f1;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 1px solid #bdc3c7;
        }

        .nav-btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #e74c3c;
        }

        .content-section {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group-full {
            margin-bottom: 20px;
        }

        .form-group-full label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group-full input,
        .form-group-full textarea,
        .form-group-full select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group-full input:focus,
        .form-group-full textarea:focus,
        .form-group-full select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group-full textarea {
            min-height: 100px;
            resize: vertical;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .question-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .question-item:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .actions-bar {
            background: #ecf0f1;
            padding: 20px;
            border-top: 1px solid #bdc3c7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .json-preview {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .shortcut-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-nav {
                flex-direction: column;
            }
            
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <h1>üîí Admin Access</h1>
        <p>Enter password to edit survey content</p>
        
        <div class="error-message" id="loginError">
            Invalid password. Please try again.
        </div>
        
        <div class="form-group">
            <label for="adminPassword">Password:</label>
            <input type="password" id="adminPassword" placeholder="Enter admin password">
        </div>
        
        <button class="btn-primary" onclick="login()">Login</button>
    </div>

    <!-- Admin Interface (hidden until login) -->
    <div class="admin-container" id="adminContainer">
        <div class="admin-header">
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            <h1>üìä Survey Content Editor</h1>
            <p>Edit survey questions and content</p>
        </div>

        <div class="admin-nav">
            <button class="nav-btn active" onclick="showSection('ui')">üìù UI Text</button>
            <button class="nav-btn" onclick="showSection('questions')">‚ùì Questions</button>
            <button class="nav-btn" onclick="showSection('categories')">üè∑Ô∏è Categories</button>
            <button class="nav-btn" onclick="showSection('shortcuts')">‚å®Ô∏è Shortcuts</button>
            <button class="nav-btn" onclick="showSection('preview')">üëÅÔ∏è Preview JSON</button>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- UI Text Section -->
        <div id="ui" class="content-section active">
            <h2 class="section-title">UI Text Editor</h2>
            <div class="form-grid">
                <div class="form-group-full">
                    <label>Survey Title</label>
                    <input type="text" id="headerTitle" placeholder="◊°◊ß◊® ◊ô◊ó◊°◊ô◊ù - Relationship Survey">
                </div>
                <div class="form-group-full">
                    <label>Survey Subtitle</label>
                    <input type="text" id="headerSubtitle" placeholder="◊ê◊†◊ê ◊¢◊†◊î ◊¢◊ú ◊î◊©◊ê◊ú◊ï◊™ ◊î◊ë◊ê◊ï◊™...">
                </div>
                <div class="form-group-full">
                    <label>Personal Info Label</label>
                    <input type="text" id="personalInfo" placeholder="◊û◊ô◊ì◊¢ ◊ê◊ô◊©◊ô (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)">
                </div>
                <div class="form-group-full">
                    <label>Name Placeholder</label>
                    <input type="text" id="namePlaceholder" placeholder="◊©◊û◊ö">
                </div>
                <div class="form-group-full">
                    <label>Email Placeholder</label>
                    <input type="text" id="emailPlaceholder" placeholder="◊ê◊ô◊û◊ô◊ô◊ú">
                </div>
                <div class="form-group-full">
                    <label>Submit Button</label>
                    <input type="text" id="submitButton" placeholder="◊©◊ú◊ó ◊™◊©◊ï◊ë◊ï◊™">
                </div>
                <div class="form-group-full">
                    <label>Progress Text</label>
                    <input type="text" id="progressText" placeholder="◊©◊ê◊ú◊î {current} ◊û◊™◊ï◊ö {total}">
                </div>
                <div class="form-group-full">
                    <label>Category A Name</label>
                    <input type="text" id="categoryA" placeholder="◊ß◊ò◊í◊ï◊®◊ô◊î A">
                </div>
                <div class="form-group-full">
                    <label>Category B Name</label>
                    <input type="text" id="categoryB" placeholder="◊ß◊ò◊í◊ï◊®◊ô◊î B">
                </div>
                <div class="form-group-full">
                    <label>Category C Name</label>
                    <input type="text" id="categoryC" placeholder="◊ß◊ò◊í◊ï◊®◊ô◊î C">
                </div>
            </div>
        </div>

        <!-- Questions Section -->
        <div id="questions" class="content-section">
            <h2 class="section-title">Manage Questions</h2>
            <div id="questionsList">
                <!-- Questions will be loaded here -->
            </div>
            <button class="btn-success" onclick="addQuestion()">‚ûï Add New Question</button>
        </div>

        <!-- Categories Section -->
        <div id="categories" class="content-section">
            <h2 class="section-title">Category Messages</h2>
            <div id="categoriesList">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Shortcuts Section -->
        <div id="shortcuts" class="content-section">
            <h2 class="section-title">Keyboard Shortcuts</h2>
            <div id="shortcutsList">
                <!-- Shortcuts will be loaded here -->
            </div>
        </div>

        <!-- Preview Section -->
        <div id="preview" class="content-section">
            <h2 class="section-title">JSON Preview</h2>
            <div class="json-preview" id="jsonPreview">
                {/* JSON will be displayed here */}
            </div>
        </div>

        <div class="actions-bar">
            <div>
                <button class="btn-success" onclick="loadContent()">üîÑ Load from File</button>
                <button class="btn-primary" onclick="saveContent()">üíæ Save to File</button>
            </div>
            <button class="btn-primary" onclick="exportJSON()">üì• Export JSON</button>
        </div>
    </div>

    <script>
        let contentData = {};
        let isAuthenticated = false;
        let authToken = '';

        // Check if already logged in (from session storage)
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = sessionStorage.getItem('adminAuthToken');
            if (savedToken) {
                verifyToken(savedToken);
            }
        });

        async function login() {
            const password = document.getElementById('adminPassword').value;
            
            if (!password) {
                showLoginError('Please enter a password');
                return;
            }

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();

                if (result.success) {
                    authToken = result.token;
                    sessionStorage.setItem('adminAuthToken', authToken);
                    isAuthenticated = true;
                    showAdminInterface();
                    loadContent();
                } else {
                    showLoginError(result.error || 'Invalid password');
                }
            } catch (error) {
                showLoginError('Login failed: ' + error.message);
            }
        }

        async function verifyToken(token) {
            try {
                const response = await fetch('/api/admin/verify', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    authToken = token;
                    isAuthenticated = true;
                    showAdminInterface();
                    loadContent();
                } else {
                    sessionStorage.removeItem('adminAuthToken');
                }
            } catch (error) {
                sessionStorage.removeItem('adminAuthToken');
            }
        }

        function logout() {
            isAuthenticated = false;
            authToken = '';
            sessionStorage.removeItem('adminAuthToken');
            showLoginInterface();
        }

        function showLoginInterface() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function showAdminInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Handle Enter key in password field
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Rest of the admin functions remain the same as previous version
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function loadContent() {
            if (!isAuthenticated) return;
            
            try {
                const response = await fetch('/api/admin/content', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load content');
                
                contentData = await response.json();
                populateForms();
                showStatus('Content loaded successfully!', 'success');
            } catch (error) {
                showStatus('Error loading content: ' + error.message, 'error');
            }
        }

        function populateForms() {
            if (!contentData.ui?.he) return;

            const ui = contentData.ui.he;
            
            document.getElementById('headerTitle').value = ui.header?.title || '';
            document.getElementById('headerSubtitle').value = ui.header?.subtitle || '';
            document.getElementById('personalInfo').value = ui.voting?.personalInfo || '';
            document.getElementById('namePlaceholder').value = ui.voting?.namePlaceholder || '';
            document.getElementById('emailPlaceholder').value = ui.voting?.emailPlaceholder || '';
            document.getElementById('submitButton').value = ui.voting?.submitButton || '';
            document.getElementById('progressText').value = ui.voting?.progressText || '';
            document.getElementById('categoryA').value = ui.categories?.A || '';
            document.getElementById('categoryB').value = ui.categories?.B || '';
            document.getElementById('categoryC').value = ui.categories?.C || '';

            populateQuestions();
            populateCategories();
            populateShortcuts();
            updatePreview();
        }

        function populateQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';
            
            if (!contentData.questions) contentData.questions = [];
            
            contentData.questions.forEach((question, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'question-item';
                questionEl.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Question ${question.id}</div>
                        <button class="btn-danger" onclick="deleteQuestion(${index})">üóëÔ∏è Delete</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group-full">
                            <label>Question Text</label>
                            <textarea onchange="updateQuestion(${index}, 'text', this.value)">${question.text || ''}</textarea>
                        </div>
                        <div class="form-group-full">
                            <label>Category</label>
                            <select onchange="updateQuestion(${index}, 'category', this.value)">
                                <option value="A" ${question.category === 'A' ? 'selected' : ''}>A</option>
                                <option value="B" ${question.category === 'B' ? 'selected' : ''}>B</option>
                                <option value="C" ${question.category === 'C' ? 'selected' : ''}>C</option>
                            </select>
                        </div>
                    </div>
                `;
                container.appendChild(questionEl);
            });
        }

        function populateCategories() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = '';
            
            if (!contentData.categoryMessages) contentData.categoryMessages = [];
            
            contentData.categoryMessages.forEach((category, index) => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'question-item';
                categoryEl.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">${category.id} - ${category.style}</div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group-full">
                            <label>Title</label>
                            <input type="text" value="${category.title || ''}" onchange="updateCategory(${index}, 'title', this.value)">
                        </div>
                        <div class="form-group-full">
                            <label>Style</label>
                            <input type="text" value="${category.style || ''}" onchange="updateCategory(${index}, 'style', this.value)">
                        </div>
                        <div class="form-group-full full-width">
                            <label>Message</label>
                            <textarea onchange="updateCategory(${index}, 'message', this.value)">${category.message || ''}</textarea>
                        </div>
                    </div>
                `;
                container.appendChild(categoryEl);
            });
        }

        function populateShortcuts() {
            const container = document.getElementById('shortcutsList');
            container.innerHTML = '';
            
            if (!contentData.keyboardShortcuts) {
                contentData.keyboardShortcuts = { desktop: [], mobile: [] };
            }
            
            contentData.keyboardShortcuts.desktop.forEach((shortcut, index) => {
                const shortcutEl = document.createElement('div');
                shortcutEl.className = 'shortcut-item';
                shortcutEl.innerHTML = `
                    <strong>Desktop Shortcut ${index + 1}</strong><br>
                    <input type="text" value="${shortcut.key}" placeholder="Key" onchange="updateShortcut('desktop', ${index}, 'key', this.value)" style="width: 100px; display: inline-block; margin-right: 10px;">
                    <input type="text" value="${shortcut.action}" placeholder="Action" onchange="updateShortcut('desktop', ${index}, 'action', this.value)" style="width: calc(100% - 120px); display: inline-block;">
                `;
                container.appendChild(shortcutEl);
            });
        }

        function updateQuestion(index, field, value) {
            if (contentData.questions[index]) {
                contentData.questions[index][field] = value;
                updatePreview();
            }
        }

        function updateCategory(index, field, value) {
            if (contentData.categoryMessages[index]) {
                contentData.categoryMessages[index][field] = value;
                updatePreview();
            }
        }

        function updateShortcut(type, index, field, value) {
            if (contentData.keyboardShortcuts[type] && contentData.keyboardShortcuts[type][index]) {
                contentData.keyboardShortcuts[type][index][field] = value;
                updatePreview();
            }
        }

        function addQuestion() {
            if (!isAuthenticated) return;
            
            const newId = contentData.questions.length > 0 ? 
                Math.max(...contentData.questions.map(q => q.id)) + 1 : 1;
            
            contentData.questions.push({
                id: newId,
                text: "New question text...",
                category: "A",
                type: "yesno"
            });
            
            populateQuestions();
            updatePreview();
            showStatus('New question added!', 'success');
        }

        function deleteQuestion(index) {
            if (!isAuthenticated) return;
            
            if (confirm('Are you sure you want to delete this question?')) {
                contentData.questions.splice(index, 1);
                populateQuestions();
                updatePreview();
                showStatus('Question deleted!', 'success');
            }
        }

        function updatePreview() {
            document.getElementById('jsonPreview').textContent = 
                JSON.stringify(contentData, null, 2);
        }

        async function saveContent() {
            if (!isAuthenticated) {
                showStatus('Please login first', 'error');
                return;
            }

            try {
                updateContentFromForms();
                
                const response = await fetch('/api/admin/save-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify(contentData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Content saved successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Save failed');
                }
            } catch (error) {
                showStatus('Error saving content: ' + error.message, 'error');
            }
        }

        function updateContentFromForms() {
            if (!contentData.ui) contentData.ui = {};
            if (!contentData.ui.he) contentData.ui.he = {};
            
            contentData.ui.he.header = {
                title: document.getElementById('headerTitle').value,
                subtitle: document.getElementById('headerSubtitle').value
            };
            
            contentData.ui.he.voting = {
                personalInfo: document.getElementById('personalInfo').value,
                namePlaceholder: document.getElementById('namePlaceholder').value,
                emailPlaceholder: document.getElementById('emailPlaceholder').value,
                submitButton: document.getElementById('submitButton').value,
                progressText: document.getElementById('progressText').value
            };
            
            contentData.ui.he.categories = {
                A: document.getElementById('categoryA').value,
                B: document.getElementById('categoryB').value,
                C: document.getElementById('categoryC').value
            };
        }

        function exportJSON() {
            if (!isAuthenticated) return;
            
            updateContentFromForms();
            const dataStr = JSON.stringify(contentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'content.json';
            link.click();
            
            showStatus('JSON file downloaded!', 'success');
        }
    </script>
</body>
</html>